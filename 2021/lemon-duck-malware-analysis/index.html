<!DOCTYPE html>
<html lang="en" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title> :: Hugo Theme Tailwind Example Site - Example site for hugo-theme-tailwind</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Lemon Duck Malware A month ago I&rsquo;ve got a Log from a company (we will call it victim corp from now) that it was detected as a malicios activity. What I&rsquo;ve got from that report log was just an URL, Funny right?! :))
I&rsquo;ve start to google dork it. After some search and googling I&rsquo;ve found some URLs and one of them was from app.any.run website which is one of the best sandbox for malware analysis and downloading samples. It seem it&rsquo;s already analyzed; however, I didn&rsquo;t hesitate and I started analyzing.
"
/>
<meta
  name="keywords"
  content="hugo, tailwind, tailwindcss, hugo theme, hugo theme tailwind"
/>
<meta name="robots" content="noodp" /><link rel="manifest" href="/manifest.json" /><meta property="og:url" content="http://localhost:1313/2021/lemon-duck-malware-analysis/">
  <meta property="og:site_name" content="Hugo Theme Tailwind Example Site">
  <meta property="og:title" content="Hugo Theme Tailwind Example Site">
  <meta property="og:description" content="Lemon Duck Malware A month ago Iâ€™ve got a Log from a company (we will call it victim corp from now) that it was detected as a malicios activity. What Iâ€™ve got from that report log was just an URL, Funny right?! :))
Iâ€™ve start to google dork it. After some search and googling Iâ€™ve found some URLs and one of them was from app.any.run website which is one of the best sandbox for malware analysis and downloading samples. It seem itâ€™s already analyzed; however, I didnâ€™t hesitate and I started analyzing.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="2021">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Hugo Theme Tailwind Example Site">
  <meta name="twitter:description" content="Lemon Duck Malware A month ago Iâ€™ve got a Log from a company (we will call it victim corp from now) that it was detected as a malicios activity. What Iâ€™ve got from that report log was just an URL, Funny right?! :))
Iâ€™ve start to google dork it. After some search and googling Iâ€™ve found some URLs and one of them was from app.any.run website which is one of the best sandbox for malware analysis and downloading samples. It seem itâ€™s already analyzed; however, I didnâ€™t hesitate and I started analyzing.">


<link rel="canonical" href="http://localhost:1313/2021/lemon-duck-malware-analysis/" />

<link rel="shortcut icon" href="/favicon.ico" />
<link rel="stylesheet" href="/css/index.f2b5b9c8e4e9b03048601ca9eedc29df44c3a73343f4538f41785e16f13c341a.css">









  
  

</head>
<body class="flex flex-col min-h-screen w-full bg-slate-50 dark:bg-gray-800">
    
<div class="fixed right-0 top-0 z-50 flex items-center justify-center bg-gray-200 p-2 text-sm uppercase text-black sm:bg-red-200 md:bg-yellow-200 lg:bg-green-200 xl:bg-blue-200 2xl:bg-pink-200">
  <span class="block sm:hidden">all</span>
  <span class="hidden sm:block md:hidden">sm</span>
  <span class="hidden md:block lg:hidden">md</span>
  <span class="hidden lg:block xl:hidden">lg</span>
  <span class="hidden xl:block 2xl:hidden">xl</span>
  <span class="hidden 2xl:block">2xl</span>
</div>

  <header class="flex flex-none justify-center z-10">
    <div class="flex flex-row gap justify-between w-full max-w-4xl lg:max-w-5xl h-12 mt-3">
  <div class="flex-none ml-2 md:ml-0">
    <a href="/" class="">
      <img class="h-12 w-12 rounded-full object-cover bg-gray-100" src="/logo.webp" alt="logo">
    </a>
  </div>
  <div class="flex-1"></div>
  <div class="flex-none">
    



<nav class="h-full static">
  <button id="navbar-menu-toggle" type="button" class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg md:hidden" aria-controls="navbar-menu" aria-expanded="false">
    <span class="sr-only">Open main menu</span>
    <i class="w-8 h-8">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 6l16 0" />
  <path d="M4 12l16 0" />
  <path d="M4 18l16 0" />
</svg>

    </i>
  </button>
  <div class="absolute md:static top-16 left-0 right-0 z-50 hidden w-full md:block md:w-auto" id="navbar-menu">
    <ul class="flex flex-col mx-2 md:mx-0 md:flex-row md:border-0 rounded-sm md:rounded-full px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5">
    
        <li id="post" class="">
          <a class="block px-3 py-3 hover:text-emerald-600"
            href="/posts" title="Post">Post</a>
        </li>
      
    
        <li id="about" class="">
          <a class="block px-3 py-3 hover:text-emerald-600"
            href="/about" title="About">About</a>
        </li>
      
    
    </ul>
  </div>
</nav>


  </div>
  
  <div class="flex-none mx-1"></div>
  
  <div class="flex-none md:hidden">
    <a href=/search/ class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls="navbar-menu" aria-expanded="false">
      <span class="sr-only">Search</span>
      <i class="w-8 h-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
    <path d="M21 21l-6 -6" />
</svg>

      </i>
    </a>
  </div>
  <div class="darkmode-toggle flex flex-none mr-2 md:mr-0">
    <label for="darkmode-toggle" class="flex items-center px-3 cursor-pointer rounded-full bg-gray-100 dark:bg-gray-600" title="Toggle dark mode">
      <input name="darkmode-toggle" id="darkmode-toggle" type="checkbox" class="sr-only peer" aria-label="Toggle dark mode">
      <div class="group flex flex-row gap-1 justify-center h-8 px-1 rounded-full bg-white dark:bg-gray-700">
        <i class="h-6 w-6 flex-none rounded-full bg-yellow-400 place-self-center peer-checked:group-[]:invisible">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brightness-down" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"></path>
   <path d="M12 5l0 .01"></path>
   <path d="M17 7l0 .01"></path>
   <path d="M19 12l0 .01"></path>
   <path d="M17 17l0 .01"></path>
   <path d="M12 19l0 .01"></path>
   <path d="M7 17l0 .01"></path>
   <path d="M5 12l0 .01"></path>
   <path d="M7 7l0 .01"></path>
</svg>

        </i>
        <i class="h-6 w-6 flex-none rounded-full place-self-center invisible peer-checked:group-[]:visible">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon-stars" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
   <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
   <path d="M19 11h2m-1 -1v2"></path>
</svg>

        </i>
      </div>
    </label>
  </div>
</div>

  </header>
  <main class="flex flex-auto justify-center">
    
<div class="w-full max-w-4xl lg:max-w-5xl">
  <div class="flex flex-col mt-6 mx-2 md:mx-0 rounded-lg overflow-hidden shadow-md bg-white dark:bg-gray-700">
    <div>
      <a href="/2021/lemon-duck-malware-analysis/">
        
      </a>
    </div>
    <div class="flex flex-col gap-y-3 p-6">
      <h1 class="text-4xl font-semibold text-slate-800 dark:text-slate-100">
        <a href="/2021/lemon-duck-malware-analysis/"></a>
      </h1>

      
      


      <div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300">
  <div class="flex flex-row text-base gap-x-1">
    <i class="h-6 w-6 flex-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hourglass-high" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M6.5 7h11"></path>
   <path d="M6 20v-2a6 6 0 1 1 12 0v2a1 1 0 0 1 -1 1h-10a1 1 0 0 1 -1 -1z"></path>
   <path d="M6 4v2a6 6 0 1 0 12 0v-2a1 1 0 0 0 -1 -1h-10a1 1 0 0 0 -1 1z"></path>
</svg>

    </i>
    <span>
      5 minutes to read
    </span>
  </div>
</div>

      

      
        
        <section class="prose prose-slate dark:prose-invert w-full max-w-4xl lg:max-w-5xl mt-6">
          <h2>Table of Contents</h2>
          <aside><nav id="TableOfContents"></nav></aside>
        </section>
        
      

      <article class="mt-6 w-full max-w-4xl lg:max-w-5xl prose prose-slate dark:prose-invert prose-quoteless post-content">
        <h1 id="lemon-duck-malware">Lemon Duck Malware</h1>
<p>A month ago I&rsquo;ve got a Log from a company (we will call it victim corp from now) that it was detected as a malicios activity. What I&rsquo;ve got from that report log was just an URL, Funny right?! :))</p>
<p>I&rsquo;ve start to google dork it. After some search and googling I&rsquo;ve found some URLs and one of them was from <code>app.any.run</code> website which is one of the best sandbox for malware analysis and downloading samples. It seem it&rsquo;s already analyzed; however, I didn&rsquo;t hesitate and I started analyzing.</p>
<p>I started collecting clues to figure out how to start my analysis. It seemed it started with some network communications so I started to look at them.
Malware communicates with a domain which is <code>hxxp://t[dot]awcna[dot]com/ipc[dot]jsp?h%22</code>. The malware download and execute a Powershell script.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>The downloaded Powershell script obfuscated multiple times. Obfuscation has been done using different techniques including <code>replace()</code> and <code>Character Reversing</code>.</p>
<p>The below picture shows the first stage of malware which is obfuscated.</p>
<!-- raw HTML omitted -->
<p>I&rsquo;m not a Powershell pro so I need some research. :) During the research I&rsquo;ve found a blog <a href="https://threat.tevora.com/5-minute-forensics-decoding-powershell-payloads" target="_blank" rel="noopener">(tevora blog)</a>
 that was quite helped me a lot and saved my time a lot.</p>
<!-- raw HTML omitted -->
<p>I&rsquo;ve found the above code in the blog, So I used that! :)
Finally&hellip; (I know there is nothing important in the script as I already analyzed it, then I use an online website to show you defeated obfuscated mechanism)</p>
<!-- raw HTML omitted -->
<p>But there is a problem! What the heck is that?! It is <code>Reversed Code</code>. :)) It is easy to defeat that! Just convert <code>IEX()</code> to <code>Write-Output</code>, Nah?!</p>
<!-- raw HTML omitted -->
<p>Now I convert it to <code>Write-Output</code>. Output is something like the below image.</p>
<!-- raw HTML omitted -->
<p>The output is obfuscated again. I use the previous technique again.</p>
<!-- raw HTML omitted -->
<p>Again&hellip; and now obfuscated is defeated successfully. Yaaay. (But every stage is obfuscated like this one, so I&rsquo;ll not cover them again).</p>
<!-- raw HTML omitted -->
<p>Now we can read the malware source code. In this stage the malware preparing for stage 0x02 (e.g. Define the variables), Also the malware creates two Tasks by <code>schtasks</code> which execute the script every 1H. Tasks&rsquo; names are chosen randomly. The malware does this to ensure it will continue correctly.</p>
<!-- raw HTML omitted -->
<p>Stage 0x02 (remind that it was obfuscated ðŸ˜„) malware extract pieces of information about the infected system like OS type, OS version, Network Configuration and &hellip; then sends it to the attacker C2 server. Attacker server response with a Powershell script which is stage 0x03 payload. The below image is a part of the stage 0x02 script.</p>
<!-- raw HTML omitted -->
<p>Stage 0x03&hellip; Again the malware extracts more information about the targeted system drivers and saves them to use later. The malware uses this information later to infect the connected drives like USB and External Hard Drive. Again some parameters will send to the attacker C2 server and stage 0x04 will download. In the next stage, some information and a currency miner will download to the victim system. To execute the currency miner, a Powershell process will be created hiddenly and by using the <code>Invoke-ReflectivePEInjection</code> from the <code>PowerSploit</code> module, the currency miner will inject into the PowerShell process. Since the process injection is Reflective, the file is not displayed in PowerShell sub-processes and is not easily detected.</p>
<p>The below image shows how the miner downloaded and injected into the process.</p>
<!-- raw HTML omitted -->
<p>In the analysis, it was found that this malware, in addition to infecting the victim system, tries to infect and affect other network systems. In the final stage, the malware spreads on the network using various techniques. The malware first attempts to exploit an operating system with a vulnerable SMB version (RCE-type vulnerability) using the EternalBlue exploit from the Empire framework. The malware developer used some obfuscation mechanism on the EternalBlue exploit to bypass the AVs and EDRs. In the below image you can compare the original exploit and modified version (the left one is the original version).</p>
<!-- raw HTML omitted -->
<p>The malware uses a tool called <strong>PingCastle</strong> to scan the network and enumerate. This module was developed by <strong>C#</strong>. The below image is the <strong>PingCastle</strong> script which is in the PowerShell script.</p>
<!-- raw HTML omitted -->
<p>The malware uses a <strong>C#</strong> script to infect attached devices which were detected in the previous stage. The malware creates a <strong>lnk</strong> file in the attached devices.</p>
<!-- raw HTML omitted -->
<p>This is so much huh?! There are more&hellip; Wait! :)</p>
<p>The malware dumps the hash of the system by <strong>Powerdump</strong> that it takes from <strong>Nishang</strong> framework. It will use for PassTheHash (PTH) attack.</p>
<!-- raw HTML omitted -->
<p>Also, a part of the stage 0x04 is dedicated to the Brute Force MsSql and RDP databases.</p>
<!-- raw HTML omitted -->
<p>if the malware finds the correct passwords, it will send them to the attacker C2 server.</p>
<!-- raw HTML omitted -->
<p>I have to point that the malware downloads a file which name is <strong>wf.cab</strong> and puts it in the <code>%TEMP%</code> folder and then it will extract it. <strong>Mimikatz</strong> and <strong>wfreerdp</strong> will extract from the <strong>wf.cab</strong> file. The <strong>Mimikatz</strong> use for PassTheHash (PTH) attack and the <strong>wfreerdp</strong> use for RDP attacks and backdoor.</p>
<!-- raw HTML omitted -->
<p>After the operations, dumped passwords and a report will send to the attacker.</p>
<p>Some websites and blogs tagged this malware as a miner, But it is not just that simple! It&rsquo;s a dangerous malware that can be an APT group behind that.
And finally, this is my simple diagram for this malware.</p>
<!-- raw HTML omitted -->

      </article>

      




    </div>
  </div>
</div>

  </main>
  <footer class="flex flex-none justify-center">
    <section class="flex flex-col md:flex-row mx-2 md:mx-0 gap-2 md:gap-0 justify-between w-full max-w-4xl lg:max-w-5xl py-6 text-slate-500 dark:text-slate-300">
  <div class="flex flex-row">
    
  
  
  
  
  
  
  
  
  
  
  


  </div>
  <div class="grow"></div>
  <div class="flex flex-row">
    <i class="h-6 w-6 flex-none"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
   <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
   <path d="M14 9.75a3.016 3.016 0 0 0 -4.163 .173a2.993 2.993 0 0 0 0 4.154a3.016 3.016 0 0 0 4.163 .173"></path>
</svg>
</i> 2023 - 2024 Your Name
    
  </div>
  
  <div class="flex flex-row">
    <span class="ml-0 pl-0 md:ml-2 md:pl-2 border-l-0 md:border-l border-slate-300 dark:border-slate-400">
      Powered by <a href="https://gohugo.io" target="_blank" rel="noopener" class="underline">Hugo</a> <span class="text-red-600">&hearts;</span> <a href="https://github.com/tomowang/hugo-theme-tailwind" target="_blank" rel="noopener" class="underline">Tailwind</a>
    </span>
  </div>
  
</section>

  </footer>
  <script src="/main.js"></script>




</body>
</html>
