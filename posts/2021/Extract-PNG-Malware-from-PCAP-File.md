## Extract PNG Malware from PCAP File

I want to talk about How I detected and extracted a PNG malware from a pcap file.
We will talk about:
- Introduction to Packet Analysis
- Introduction to Wireshark
- Detect Malicious Network Traffic
- Partial Content Responses
- Impact of Connection Problems
- Extract Malicious File from HTTP for analysis and Reverse Engineering

Nowadays cyber attacks have become more sophisticated. The use of malware is increasing, Malware comes in many forms such as:
- Trojan
- Worms
- Viruses
- etc.

Malware communicates with different domains and IP addresses for various reasons (e.g. Connect to [C&C](https://www.trendmicro.com/vinfo/us/security/definition/command-and-control-server), Download the [Real Malware](https://www.f-secure.com/v-descs/trojan-downloader.shtml), etc.). One of the steps of **Malware Analysis** is to examine these network connections.

We can analyse Malware network communications with different methods and tools, We can use some tools such as [FakeNet](https://sourceforge.net/projects/fakenet) or [iNetSim](https://www.inetsim.org) to simulate and analyse outgoing connections, also we can analyse the captured network packets such as `.pcap` file, which can be analyse by [Wireshark](https://www.wireshark.org).

Wireshark is a free and open-source packet analyzer. It is used for network troubleshooting, analysis, software and communications protocol development, and education.

![](https://user-images.githubusercontent.com/36133745/113446492-1e5f9b80-940d-11eb-9601-103b9a765d13.png)
_Wireshark Application_

Wireshark contains 3 windows, top window (green background color) which name is **Packet List**, the middle one is Packet Details window and bottom window is Packet Bytes.
- Packet List: Displays packets sent in a network interface.
- Packet Details: Displays the information and headers of a sent packet in details.
- Packet Bytes: This section displays the contents of a sent package in HEX and ASCII.

I want to analyse malicious network communication (for a malware) from PCAP file in this post. First we're going to open PCAP file (malware.pcap) in Wireshark, to do this, Select `File -> Open` from menu bar. (or simply use Ctrl + O shortcut key).

![2021-04-01_20-04](https://user-images.githubusercontent.com/36133745/113447819-de4de800-940f-11eb-9746-17df0235c659.png)

When you Open a PCAP file, depends on the system resources and PCAP size, it can takes seconds or minutes to open.

It seems there are lots of packets in PCAP file.

![2021-04-01_20-12](https://user-images.githubusercontent.com/36133745/113448970-15bd9400-9412-11eb-9bc1-c5e6fce9ccca.png)

Select `Statistics -> Capture File Properties` from menu bar (Shortcut: `Ctrl+Alt+Shift+C`) to see some information about pcap file.

![5](https://user-images.githubusercontent.com/36133745/118025110-b2aa1000-b374-11eb-95a9-8e3cd07d35b3.png)

In the opened window, we can see how many packets captured and as already we guessed there is 931 packet.

![6-1024x626](https://user-images.githubusercontent.com/36133745/118025674-58f61580-b375-11eb-8d1e-8940587c132c.png)

Now we must make a list of endpoints in the captured packets. to do this just select `Statistics -> Endpoints` from menu bar.

![7](https://user-images.githubusercontent.com/36133745/118026034-a2defb80-b375-11eb-9164-2eebfe3ff4a6.png)

Now we can see endpoints, easy right?!

![8](https://user-images.githubusercontent.com/36133745/118026107-b722f880-b375-11eb-8e4d-9c354b59cf34.png)

What we have learned so far is that, there are so many endpoints and also we have 931 packets. Now we should determine what kind of connections do we have.
To do this select `Statistics -> Protocol Hierarchy` from menu bar.

![9](https://user-images.githubusercontent.com/36133745/118026627-4203f300-b376-11eb-8d3c-90a73b9dcd85.png)

It seems most of the requests were DNS requests or HTTP requests.

![10-1024x241](https://user-images.githubusercontent.com/36133745/118027186-e423db00-b376-11eb-8bff-c347dfd80be1.png)

We will now start reviewing some of the packets sent. As you can see at the top image, there are some media types connections. If we look at captured packets in-depth, we can find a word (.doc) document and an image with **PNG** extension.

> Note
> 
> Malwares use different type of techniques to avoid detection by monitoring systems.
> One of these techniques is downloading a malicious file by trojan with png, pdf, etc. file foramt.

Below image shows sent packets to download **78654543.png** file. First `HEAD` request is to ensure file exists and then download of image is started.

![11](https://user-images.githubusercontent.com/36133745/118029171-23532b80-b379-11eb-95b3-c5a404d9ba42.png)


But WAIT! The response type from the server is `206 Partial Content`! This status means that the file has a large size and the server divided it into small pieces (Segmentation) and send them. Right click on one of the **PNG** request and then select `Follow -> HTTP Stream` (Shortcut: Ctrl+Alt+Shift+H) also you can choose `TCP Stream`, it doesn't make any difference here.

![12](https://user-images.githubusercontent.com/36133745/118034006-ba6eb200-b37e-11eb-9ffc-429bdb583f7d.png)

Another window will open which contains requests packets to download **PNG** file.
If you look at it carefully, you will see a suspicious thing, **PNG** is a Windows executable file. You can detect it with file header (`MZ`).

![14-1024x771](https://user-images.githubusercontent.com/36133745/118034283-0de10000-b37f-11eb-8a10-c556e411dd6d.png)

So this is a malicious request. We need to extract this file from captured requests to give it to malware analysts for in-depth analysis and reverse engineering to understand what does this malware. There are several ways to do it, One of the simple ways is to use `Export Objects`, Select `File -> Export Objects -> HTTP` from the menu bar.

![15](https://user-images.githubusercontent.com/36133745/118100169-62ba6000-b3eb-11eb-9b02-8a709ecbe2df.png)

The following window will open and the sent and received files by HTTP Protocol will be visible.

![16](https://user-images.githubusercontent.com/36133745/118110784-16c1e800-b3f8-11eb-8169-d3c40b917639.png)

As you can see cause of `Partial Content` response type, files are divided into multiple parts. The Files can be downloaded and merged, to download and save the files click on each part and select `Save` button.

![17-1024x631](https://user-images.githubusercontent.com/36133745/118111182-9780e400-b3f8-11eb-8fb8-309ba7ce8eab.png)

It seems part 4 had some trouble and it's corrupted. I'm sure because in `TCP Stream` the fourth request is 12089 bytes but the fourth request in top image is 24 KB.

![18-1024x955](https://user-images.githubusercontent.com/36133745/118115957-dfa30500-b3fe-11eb-8222-a1bd3105ab55.png)

If we check the `Partial Content` requests, We will see there is a problem in fourth request and cause of TCP nature file downloaded twice.

![19-1024x312](https://user-images.githubusercontent.com/36133745/118116789-f6962700-b3ff-11eb-8a51-a1532b28759f.png)

To ensure that select `Statistics -> I/O Graphs` and you will see TCP errors.

![20](https://user-images.githubusercontent.com/36133745/118117010-45dc5780-b400-11eb-93f0-96dc96f0d400.png)
![21](https://user-images.githubusercontent.com/36133745/118117047-4d036580-b400-11eb-89d2-9cc0fd3ce72a.png)

it seems Wireshark doesn't have ability to detect these issues and fix errors, Then we need a way to fix this problem. Let's Use Google/DuckDuckGo.

One of the result in google is a SANS paper which introduce ChaosReader.

![22](https://user-images.githubusercontent.com/36133745/118117229-95bb1e80-b400-11eb-8589-064361fa8d7a.png)

A brief introduction is in the paper about ChaosReader tool.

![23-1024x680](https://user-images.githubusercontent.com/36133745/118117300-b4211a00-b400-11eb-9321-d9d89f65d5c2.png)

To try this tools, search it on google and download it.

![24](https://user-images.githubusercontent.com/36133745/118117516-fc403c80-b400-11eb-8be8-fd3aef88c933.png)

This tools written in **Perl** language. You will encounter an error while running the tool.

![25](https://user-images.githubusercontent.com/36133745/118117922-6eb11c80-b401-11eb-8821-6252f672362e.png)

The root of the problem is the version used. Open chaosreader in a editor (like `NeoVIM`) and go to line 265 and comment this line.

![26](https://user-images.githubusercontent.com/36133745/118119068-0bc08500-b403-11eb-976a-ca010ca083f0.png)

Save the file and run it again. this time run it with `--help` switch to see the help page?! :)


![27-1024x674](https://user-images.githubusercontent.com/36133745/118119247-52ae7a80-b403-11eb-96f4-5d6a934990ed.png)

It seems the tool need a switch to run whole process on a pcap file. First craete a directory and move the pcap file and chaosreader to it (because the output of chaosreader process is in the current directory and it is mess output :)). Run the tool with `-e` switch and give it pcap file name. The tool create some html, hex and other type of files.

![28-1024x606](https://user-images.githubusercontent.com/36133745/118119615-e08a6580-b403-11eb-8802-862bd6618476.png)

There is a file with **index.html** name in the directory of output, open it in browser (like Firefox, Chromium). According to the size and counts of the HTTP responses in a TCP session we can guess the red box marked in the below image is for download Malicious **PNG** file. (You can use **as_html** or **hex** to see the content)

![29-1024x780](https://user-images.githubusercontent.com/36133745/118120351-fea49580-b404-11eb-9b8e-b2e906e3e424.png)

Now we can download files with `.data` extension or copy it from output directory and then merged them as a file with `cat` command in GNU/Linux or BSD.

![30-1024x563](https://user-images.githubusercontent.com/36133745/118120487-39a6c900-b405-11eb-98f2-529f173edf27.png)

Now the malware is ready with `malware._exe` name. All we need now is to open it in a reverse engineering tool like **Radare2**,**IDA Pro** or **Ghidra**, etc..

![31-1024x567](https://user-images.githubusercontent.com/36133745/118120624-6ce95800-b405-11eb-9fbe-2e552846060d.png)

File seems OK and it's a PE file. If you check strings of the file, we see it is developed by **C++** programming language. Now a malware analyst can reverse and analyse this. The rest of the process involves reverse engineering knowledge and malware analysis, and now a malware analyst can examine it.
