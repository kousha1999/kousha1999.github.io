# Lemon Duck Malware or APT?!

A month ago I've got a Log from a company (we will call it victim corp from now) that it was detected as a malicios activity. What I've got from that report log was just an URL, Funny right?! :))

I've start to google dork it. After some search and googling I've found some URLs and one of them was from `app.any.run` website which is one of the best sandbox for malware analysis and downloading samples. It seems it's already analyzed. So i didn't stop because I wanted to analyze it myself.

I started collecting clues to figure out how to start my analysis. It seemed it started with some network communications so I started to look at them.
Malware communicates with a domain which is `hxxp://t[dot]awcna[dot]com/ipc[dot]jsp?h%22`. The malware download and execute a Powershell script.

<!--![Stage-1](https://user-images.githubusercontent.com/36133745/119378384-79a65f80-bcd3-11eb-9f82-3a3bbf0bfc4d.png)-->
<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119378384-79a65f80-bcd3-11eb-9f82-3a3bbf0bfc4d.png">
</p>

The downloaded Powershell script obfuscated in multiple times. Obfuscation has been done using different techniques including `replace()` and `Character Reversing`.
The below picture shows the first stage of malware which is obfuscated.

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119380119-8b890200-bcd5-11eb-992d-9b3f425ad7b9.png">
</p>

I'm not a Powershell pro so i need some research. :) During the research I've found a blog [(tevora blog)](https://threat.tevora.com/5-minute-forensics-decoding-powershell-payloads) that was quite helped me a lot and saved my time a lot. 


<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119380411-ec183f00-bcd5-11eb-8bee-acc89fae93c6.png">
</p>

I've found the above code in the blog, So I used that! :)
Finally... (I know there is nothing important in the script as I already analyzed it, then i use online website to show you defeated obfuscated mechanism)

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119382872-e4599a00-bcd7-11eb-866a-0c42472d2ae3.png">
</p>

But there is a problem! What the heck is that?! It is `Reversed Code`. :)) It is easy to defeat that! Just convert `IEX()` to `Write-Output`, Nah?!
<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119383592-c2144c00-bcd8-11eb-8a65-4af06346653e.png">
</p>

Now I convert it to `Write-Output`. Output is something like the below image.

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119383809-0c95c880-bcd9-11eb-8264-e948d3f1c4d8.png">
</p>

The output is obfuscated again. Again I use the previous technique again.

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119384258-a9586600-bcd9-11eb-9cda-15614c02fd8f.png">
</p>
The left window is the output. Obfuscated again... But i promise this is the last one. :))
<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119384378-de64b880-bcd9-11eb-8a08-8353ed98b7dc.png">
</p>

Again... and now obfuscated is defeated successfully. Yaaay. (But every stage is obfuscated like this one, so I'll not cover them again).
<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119384632-40252280-bcda-11eb-87a8-7859bc373ea8.png">
</p>

Now we can read the malware source code. In this stage the malware preparing for stage 0x02 (e.g. Define the variables), Also the malware creates two Task by `schtasks` which execute the script every 1H. Tasks names are chosen randomly. The malware does this to ensure it will continue correctly.

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119385109-ef61f980-bcda-11eb-9e48-4d451660822a.png">
</p>

The stage 0x02 (remind that it was obfuscated ðŸ˜„) malware extract informations about infected system like OS type, OS version, Network Configuration and ... then sends it to attacker C2 server. Attacker server response with a Powershell script which is stage 0x03 payload. The below image is a part of stage 0x02 script.

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119385685-be35f900-bcdb-11eb-8dde-e8c52703a9b7.png">
</p>

Stage 0x03... Again the malware extract more information about the targeted system drivers and save them to use later. The malware use this information later to infect the connected drives like USB and External Hard Drive. Again some parameters will send to attacker C2 server and stage 0x04 will download. In the next stage, some information and a currency miner will download to victim system. In order to execute the currency miner, a Powershell process will be created hiddenly and by using `Invoke-ReflectivePEInjection`from `PowerSploit` module, the currency miner will inject into the PowerShell process. Due to the fact that the process injection is Reflective, the file is not displayed in PowerShell sub-processes and is not easily detected.

The below image shows how miner downloaded and injected into the process.

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119385958-22f15380-bcdc-11eb-9434-2f87807fe3a3.png">
</p>

In the analysis, it was found that this malware, in addition to infecting the victim system, tries to infect and affect other network systems. In the final stage, the malware spreads on the network using various techniques. The malware first attempts to exploit an operating system with a vulnerable SMB version (RCE-type vulnerability) using the EternalBlue exploit from the Empire framework. The malware developer used some obfuscation mechanism on EternalBlue exploit to bypass the AVs and EDRs. In the below image you can compare the origiran exploit and modified version (the left one is the original version).

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119387742-9a27e700-bcde-11eb-870b-952a669861bc.png">
</p>
<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119387889-d52a1a80-bcde-11eb-9a70-e4f7d25cda5d.png">
</p>

The malware use a tool called **PingCastle** to scan the network and enumerate. This module developed by **C#**. The below image is the **PingCastle** script which is in the PowerShell script.

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119388306-597c9d80-bcdf-11eb-8397-abfc68cf8955.png">
</p>

The malware use a **C#** script to infect attached devices which detected in the previous stage. The malware create a **lnk** file in the attached devices.
<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119389617-220ef080-bce1-11eb-99f6-85d00ae544fc.png">
</p>

This is so much huh?! There are more... Wait! :)

The malware dump the hash of the system by **Powerdump** that it takes from **Nishang** framework. It will use for PassTheHash (PTH) attack.

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119390121-d27cf480-bce1-11eb-9575-d39510dd1999.png">
</p>

Also a part of the stage 0x04 is dedicated to the Brute Force MsSql and RDP databases.

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119390688-a7df6b80-bce2-11eb-98ef-6f74e8379e4e.png">
</p>

if the malware find the correct passwords, it will send them to attacker C2 server.

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119390846-d9f0cd80-bce2-11eb-92a7-c9c95e4a7dee.png">
</p>

