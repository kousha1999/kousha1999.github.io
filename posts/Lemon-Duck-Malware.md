# Lemon Duck Malware or APT?!

A month ago I've got a Log from a company (we will call it victim corp from now) that it was detected as a malicios activity. What I've got from that report log was just an URL, Funny right?! :))

I've start to google dork it. After some search and googling I've found some URLs and one of them was from `app.any.run` website which is one of the best sandbox for malware analysis and downloading samples. It seems it's already analyzed. So i didn't stop because I wanted to analyze it myself.

I started collecting clues to figure out how to start my analysis. It seemed it started with some network communications so I started to look at them.
Malware communicates with a domain which is `hxxp://t[dot]awcna[dot]com/ipc[dot]jsp?h%22`. The malware download and execute a Powershell script.

<!--![Stage-1](https://user-images.githubusercontent.com/36133745/119378384-79a65f80-bcd3-11eb-9f82-3a3bbf0bfc4d.png)-->
<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119378384-79a65f80-bcd3-11eb-9f82-3a3bbf0bfc4d.png">
</p>

The downloaded Powershell script obfuscated in multiple times. Obfuscation has been done using different techniques including `replace()` and `Character Reversing`.
The below picture shows the first stage of malware which is obfuscated.

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119380119-8b890200-bcd5-11eb-992d-9b3f425ad7b9.png">
</p>

I'm not a Powershell pro so i need some research. :) During the research I've found a blog [(tevora blog)](https://threat.tevora.com/5-minute-forensics-decoding-powershell-payloads) that was quite helped me a lot and saved my time a lot. 


<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119380411-ec183f00-bcd5-11eb-8bee-acc89fae93c6.png">
</p>

I've found the above code in the blog, So I used that! :)
Finally... (I know there is nothing important in the script as I already analyzed it, then i use online website to show you defeated obfuscated mechanism)

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119382872-e4599a00-bcd7-11eb-866a-0c42472d2ae3.png">
</p>

But there is a problem! What the heck is that?! It is `Reversed Code`. :)) It is easy to defeat that! Just convert `IEX()` to `Write-Output`, Nah?!
<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119383592-c2144c00-bcd8-11eb-8a65-4af06346653e.png">
</p>

Now I convert it to `Write-Output`. Output is something like the below image.

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119383809-0c95c880-bcd9-11eb-8264-e948d3f1c4d8.png">
</p>

The output is obfuscated again. Again I use the previous technique again.

<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119384258-a9586600-bcd9-11eb-9cda-15614c02fd8f.png">
</p>
The left window is the output. Obfuscated again... But i promise this is the last one. :))
<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119384378-de64b880-bcd9-11eb-8a08-8353ed98b7dc.png">
</p>

Again... and now obfuscated is defeated successfully. Yaaay. (But every stage is obfuscated like this one, so I'll not cover them again).
<p align="center">
<img src="https://user-images.githubusercontent.com/36133745/119384632-40252280-bcda-11eb-87a8-7859bc373ea8.png">
</p>

Now we can read the malware source code. In this stage the malware preparing for stage 0x02 (e.g. Define the variables), Also the malware creates two Task by `schtasks` which execute the script every 1H. Tasks names are chosen randomly. The malware does this to ensure it will continue correctly.
